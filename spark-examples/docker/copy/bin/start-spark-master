#!/bin/bash
set -x
function check_start {
    if [ $1 -ne 0 ]; then
        echo "Failed to start $2: $1"
        exit $1
    fi
}

function check_running {
    ps aux | grep $1 | grep -q -v grep
    status=$?
    if [ $status -ne 0 ]; then
        echo "$1 stopped. Terminating"
        exit $status
    fi
}

hostname=`hostname`

cd $USER_HOME/rw
mkfifo hadoop
mkfifo spark
fluent-bit -d -i tail -p path=./hadoop -p path=./spark -o forward://fluentd:24224
check_start $? fluent-bit

start-hadoop-namenode > ./hadoop &
check_start $? start-hadoop-namenode

spark-class org.apache.spark.deploy.master.Master > ./spark &
check_start $? spark-master

while /bin/true; do
    sleep 60
#    check_running fluent-bit
    # check_running start-hadoop-namenode
    # check_running org.apache.spark.deploy.master.Master
done
