#!/bin/bash
set -x
function check_start {
    if [ $1 -ne 0 ]; then
        echo "Failed to start $2: $1"
        exit $1
    fi
}

function check_running {
    ps aux | grep $1 | grep -q -v grep
    status=$?
    if [ $status -ne 0 ]; then
        echo "$1 stopped. Terminating"
        exit $status
    fi
}

hostname=`hostname`
syslogd -R fluentd:5140
check_start $? syslogd

start-hadoop-namenode | logger -t $hostname.namenode &
check_start $? start-hadoop-namenode

spark-class org.apache.spark.deploy.master.Master | logger -t $hostname.sparkmaster &
check_start $? spark-master

while /bin/true; do
    check_running start-hadoop-namenode
    check_running org.apache.spark.deploy.master.Master
    sleep 60
done
